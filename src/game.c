//----------------------------------------------------------------------------------------------------------------------
//! @file       game.c
//! @brief      Game main loop.
//! @author     Matt Davies
//! @copyright  Copyright (C)2018 Bit-7 Technology, all rights reserved.
//----------------------------------------------------------------------------------------------------------------------

#include <game.h>

//----------------------------------------------------------------------------------------------------------------------
// World
//----------------------------------------------------------------------------------------------------------------------

STRUCT_START(World)
{
    int width;
    int x;
    f64 t;
}
STRUCT_END(World);

World gWorld;

//----------------------------------------------------------------------------------------------------------------------
// Initialisation
//----------------------------------------------------------------------------------------------------------------------

void init()
{
    gWorld.width = 80;
    gWorld.x = 0;
    gWorld.t = 0;
}

//----------------------------------------------------------------------------------------------------------------------
// Shutdown
//----------------------------------------------------------------------------------------------------------------------

void done()
{

}

//----------------------------------------------------------------------------------------------------------------------
// Simulate
//----------------------------------------------------------------------------------------------------------------------

bool simulate(const SimulateIn* sim)
{
    bool result = YES;
    static const f64 clock = 0.1;

    gWorld.t += sim->dt;
    if (gWorld.t > clock)
    {
        //t -= clock;
        gWorld.t = 0.0;
        ++gWorld.x;
        if (gWorld.x >= gWorld.width) gWorld.x = 0;
    }

    i64 numKeyEvents = arrayCount(sim->key);
    if (numKeyEvents)
    {
        for (i64 i = 0; i < numKeyEvents; ++i)
        {
            KeyState* kev = &sim->key[i];
            if (kev->down && kev->vkey == VK_ESCAPE) result = NO;
        }
    }

    return result;
}

//----------------------------------------------------------------------------------------------------------------------
// Present
//----------------------------------------------------------------------------------------------------------------------

void present(const PresentIn* pin)
{
    for (int i = 0; i < pin->width * pin->height; ++i)
    {
        pin->foreImage[i] = 0xff0000ff;
        pin->backImage[i] = 0xff000000;
        pin->textImage[i] = (u32)'.';
    }

    pin->textImage[pin->width * 2 + gWorld.x] = (u32)'@';
    pin->foreImage[pin->width * 2 + gWorld.x] = 0xff00ff00;

    gWorld.width = pin->width;
}
